<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Kubernetes Controller Pattern Example with Java and MySQL - fn:join</title>
<meta name=description content="A controller written in Java that creates MySQL databases in a Kubernetes cluster">
<meta name=author content="Salman Malik, Archie Cowan"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"fn:join","url":"https:\/\/fnjoin.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/fnjoin.com\/"}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/fnjoin.com\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/fnjoin.com\/post\/2022-11-08-k8s-controller-java\/","name":"Kubernetes controller pattern example with java and my SQL"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Salman Malik"},"headline":"Kubernetes Controller Pattern Example with Java and MySQL","description":"This post is a continuation of Kubernetes with Java - Handling Events which showed us how to subscribe to API events for a given type of Kubernetes resource and deal with them in near real-time. In this post, we will learn how to use that capability along side other client machinery components to write a Kubernetes controller.\nWhat are we trying to do For this post, our goal is to make it easier to create multiple MySQL database instances in a Kubernetes cluster.","inLanguage":"en","wordCount":2688,"datePublished":"2022-11-08T00:00:00","dateModified":"2022-11-08T00:00:00","image":"https:\/\/fnjoin.com\/","keywords":["java, kubernetes, spring-boot, api-events, controller, mysql"],"mainEntityOfPage":"https:\/\/fnjoin.com\/post\/2022-11-08-k8s-controller-java\/","publisher":{"@type":"Organization","name":"https:\/\/fnjoin.com\/","logo":{"@type":"ImageObject","url":"https:\/\/fnjoin.com\/","height":60,"width":60}}}</script>
<meta property="og:title" content="Kubernetes Controller Pattern Example with Java and MySQL">
<meta property="og:description" content="A controller written in Java that creates MySQL databases in a Kubernetes cluster">
<meta property="og:url" content="https://fnjoin.com/post/2022-11-08-k8s-controller-java/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="fn:join">
<meta name=twitter:title content="Kubernetes Controller Pattern Example with Java and MySQL">
<meta name=twitter:description content="A controller written in Java that creates MySQL databases in a Kubernetes cluster">
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@fnjoin">
<meta name=twitter:creator content="@fnjoin">
<link href=https://fnjoin.com/img/favicon.ico rel=icon type=image/x-icon>
<meta name=generator content="Hugo 0.89.4">
<link rel=alternate href=https://fnjoin.com/index.xml type=application/rss+xml title=fn:join><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous>
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://fnjoin.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
<link rel=stylesheet href=https://fnjoin.com/css/highlight.min.css><link rel=stylesheet href=https://fnjoin.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPSKLMVM2V"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-ZPSKLMVM2V')</script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top navbar-custom">
<div class=container-fluid>
<div class=navbar-header>
<button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://fnjoin.com/>fn:join</a>
</div>
<div class="collapse navbar-collapse" id=main-navbar>
<ul class="nav navbar-nav navbar-right">
<li>
<a title=Blog href=/>Blog</a>
</li>
<li>
<a title=About href=/page/about/>About</a>
</li>
<li>
<a title=Tags href=/tags>Tags</a>
</li>
</ul>
</div>
</div>
</nav>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header class=header-section>
<div class="intro-header no-img">
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<h1>Kubernetes Controller Pattern Example with Java and MySQL</h1>
<h2 class=post-subheading>A controller written in Java that creates MySQL databases in a Kubernetes cluster</h2>
<span class=post-meta>
<i class="fas fa-calendar"></i>&nbsp;Posted on November 8, 2022
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;13&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Salman Malik
</span>
</div>
</div>
</div>
</div>
</div>
</header>
<div class=container role=main>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<article role=main class=blog-post>
<p>This post is a continuation of <a href=../2022-01-03-k8s-event-handling>Kubernetes with Java - Handling Events</a> which showed us how to subscribe to API events for a given type of Kubernetes resource and deal with them in near real-time. In this post, we will learn how to use that capability along side other client machinery components to write a Kubernetes controller.</p>
<h2 id=what-are-we-trying-to-do>What are we trying to do</h2>
<p>For this post, our goal is to make it easier to create multiple MySQL database instances in a Kubernetes cluster. To do that manually, one would need to create/maintain the following built-in Kubernetes resources for each database:</p>
<ul>
<li>A <em>StatefulSet</em> resource that will create a <em>Pod</em> with a <em>PersistentVolume</em> so that we don&rsquo;t lose our database data</li>
<li>A <em>Service</em> resource to front MySQL <em>Pod</em> with a consistent DNS name</li>
<li>A <em>Secret</em> resource that will keep the connection and credentials information to connect to that database instance</li>
</ul>
<p>To support having databases of varying capabilities, we would need to parameterize CPU, memory, and storage requirements for each database.</p>
<h2 id=attempt-at-defining-kubernetes>Attempt at defining Kubernetes</h2>
<p>Before we work towards our goal, we need to step back and understand how Kubernetes fundamentally works. At the simplest level, Kubernetes is a platform consisting of an API server which handles CRUD operations for lots of resource types. In reponse to the CRUD operations, after storing the state of resources in an internal database (<em>etcd</em>), the API server publishes events describing the change to those resources. Those events are subscribed by other components that come bundled with every Kubernetes cluster called <strong>controllers</strong>. The controllers handle the lifecycle of the resource type they were written for and issue CRUD commands through the API server to change the state of their own resource or child resources.</p>
<blockquote>
<p>For example, a <strong>ReplicaSet</strong> controller will NOT only listen to events for its own resource type but will also be listening to events for <strong>Pod</strong> resources. It will probably ask the API server to create or delete <strong>Pod</strong> resources as it tries to reconcile what <strong>Pod</strong> resources are presently running and what was specified in the <strong>ReplicaSet</strong> definition.</p>
</blockquote>
<p>In addition to the built-in resources like <em>Pod</em>, <em>ReplicaSet</em>, or <em>Deployment</em>, Kubernetes allows you to extend its functionality by registering your own custom-resource types and controllers to handle their lifecycles. The custom-resource are represented by a <em>CustomResourceDefinition</em> resource (aka <em>CRD</em>) and describes the group, kind, version, spec, and status sections of the custom-resource. In addition, <em>printer-column</em> attributes are also defined in the <em>CRD</em>. <code>kubectl</code> and other tools like it (<a href=../2022-02-07-fav-k8s-cli-tool>k9s</a>) use these attributes to show a summary of the resource.</p>
<h2 id=back-to-solving-our-problem>Back to solving our problem</h2>
<p>We will define and register a custom-resource of type <em>Mysql</em> with our cluster. This custom-resource will allow us to define a database with set CPU, memory, and storage resources. Also, like all other Kubernetes resources types, there will be a place to store the current status in the custom-resource. We will also need to create a controller which uses the Kubernetes Client machinery to implement the Kubernetes controller pattern so it can handle the lifecycle of <em>Mysql</em> resources.</p>
<blockquote>
<p>We will not be producing a production grade MySQL controller/operator. It will be missing a lot of features which for example <a href=https://dev.mysql.com/doc/mysql-operator/en/mysql-operator-introduction.html>MySQL Operator for kubernetes</a> or <a href=https://docs.vmware.com/en/VMware-Tanzu-SQL-with-MySQL-for-Kubernetes/index.html>VMware Tanzu SQL with MySQL for Kubernetes</a> provide. Those features include ability to have read replicas, perform automated backups, provide seamless version upgrades, etc. Instead, our goal is to showcase how to write a controller using Kubernetes Client for Java and spring-boot which does something useful.</p>
</blockquote>
<p>Our <em>Mysql</em> CRD is defined as:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apiextensions.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CustomResourceDefinition</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysqls.fnjoin.com</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span><span class=w>  </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>fnjoin.com</span><span class=w>
</span><span class=w>  </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>plural</span><span class=p>:</span><span class=w> </span><span class=l>mysqls</span><span class=w>
</span><span class=w>    </span><span class=nt>singular</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Mysql</span><span class=w>
</span><span class=w>  </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>served</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>schema</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>openAPIV3Schema</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span><span class=w>          </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span><span class=w>              </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>cpu</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>                </span><span class=nt>memory</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>                </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>            </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span><span class=w>              </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>ready</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>boolean</span><span class=w>
</span><span class=w>                </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>array</span><span class=w>
</span><span class=w>                  </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span><span class=w>                    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span><span class=w>                    </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span><span class=w>                      </span><span class=nt>type</span><span class=p>:</span><span class=w>
</span><span class=w>                        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>                      </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>                        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>                      </span><span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w>
</span><span class=w>                        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>                        </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>date-time</span><span class=w>
</span><span class=w>      </span><span class=nt>additionalPrinterColumns</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>          </span><span class=nt>jsonPath</span><span class=p>:</span><span class=w> </span><span class=l>.spec.storage</span><span class=w>
</span><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Storage capacity allocated</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>          </span><span class=nt>jsonPath</span><span class=p>:</span><span class=w> </span><span class=l>.spec.memory</span><span class=w>
</span><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Memory allocated</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>          </span><span class=nt>jsonPath</span><span class=p>:</span><span class=w> </span><span class=l>.spec.cpu</span><span class=w>
</span><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>CPU millis allocated</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ready</span><span class=w>
</span><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span><span class=w>          </span><span class=nt>jsonPath</span><span class=p>:</span><span class=w> </span><span class=l>.status.ready</span><span class=w>
</span><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Is MySql resource ready</span><span class=w>
</span></code></pre></div><p>Notice that our <em>CRD</em> defines a <em>status</em> section but we didn&rsquo;t set any <em>status</em> details ourselves in the YAML above. Also, the <em>metadata</em> section is inherited by all Kubernetes resources, it has a standard structure, and we don&rsquo;t need to define it in our <em>CRD</em>. Maintaining the <em>status</em> section of a resource is one of the main things a controller takes care of. Our controller will also do that. With that <em>CRD</em> applied to the cluster, we can define a <code>Mysql</code> resource which looks like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>fnjoin.com/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Mysql</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span><span class=w>  </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span><span class=w>  </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span><span class=w>
</span></code></pre></div><p>The other main thing that our controller needs to do is to create and maintain child resources when needed. To visualize how our controller will interact with other components in the Kubernetes cluster, see the following diagram:</p>
<link rel=stylesheet href=https://fnjoin.com/css/hugo-easy-gallery.css>
<div class=box>
<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject>
<div class=img>
<img itemprop=thumbnail src=/img/k8s-controller-java/overview.jpg alt="Kubernetes Server Components Overview">
</div>
<a href=/img/k8s-controller-java/overview.jpg itemprop=contentUrl></a>
</figure>
</div>
<h2 id=kubernetes-client-machinery-involved>Kubernetes Client machinery involved</h2>
<p>What goes into creating the controller? We already know about the <em>Informer</em> and the associated <em>Indexer</em> objects from our <a href=../2022-01-03-k8s-event-handling>previous post</a>. Once setup, these objects listen to incoming API events when the Kubernetes API server adds, deletes, or changes any resources we are interested in. In addition, we will now introduce <em>WorkQueue</em>, <em>Reconciler</em>, and <em>Controller</em> objects.</p>
<p>The <em>WorkQueue</em> object acts as the recipient of events coming from the <em>Informer</em>. The <em>WorkQueue</em> intentionally loses all details from the events it recieves and converts them into <em>Request</em> objects which only have two attributes: <em>namespace</em> and <em>name</em>. This allows the <em>WorkQueue</em> to also apply rate-limiting logic to squash multiple events refering to the same entity as one.</p>
<blockquote>
<p>An interesting thing to note is that Kubernetes team publishes client libraries in multiple languages and use the same terms in all of the libraries. So for example, a <strong>WorkQueue</strong> works the same way no matter which language client library you use.</p>
</blockquote>
<p>The <em>Reconciler</em> then uses the <em>WorkQueue</em> as its input and tries to reconcile the world everytime it gets a <em>Request</em> from the <em>WorkQueue</em>.</p>
<p>Finally, a <em>Controller</em> is composed of all of the above objects and works with a <em>java.util.concurrent.ExecutorService</em> to perform its work in a multi-threaded environment. The controller will also implement a leader-election mechanism to make sure that only a single instance of the controller can reconcile the world. It would be chaos otherwise.</p>
<h2 id=code-organization>Code Organization</h2>
<p>While creating this controller, we realized that a lot of what goes into creating a controller can be categorized as boiler-plate. So we organized the boiler-plate code in a <code>com.fnjoin.k8s.controller.customresource.base</code> package. All the controller code specific to our <code>Mysql</code> custom-resource went in the <code>com.fnjoin.k8s.controller.customresource.mysql</code> package. See how the code is laid out:</p>
<div class=box>
<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject>
<div class=img>
<img itemprop=thumbnail src=/img/k8s-controller-java/code-organization.png alt="Code Organization">
</div>
<a href=/img/k8s-controller-java/code-organization.png itemprop=contentUrl></a>
</figure>
</div>
<blockquote>
<p>Perhaps, in the future the <code>base</code> package can be bundled as a library.</p>
</blockquote>
<h2 id=initializing-the-controller>Initializing the Controller</h2>
<p>With the Kubernetes Client machinery discussed earlier, we can visualize the initialization of a controller like so:</p>
<div class=box>
<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject>
<div class=img>
<img itemprop=thumbnail src=/img/k8s-controller-java/initializing.jpg alt=" Initializing the Controller">
</div>
<a href=/img/k8s-controller-java/initializing.jpg itemprop=contentUrl></a>
</figure>
</div>
<p>The <code>init(...)</code> method from our abstract controller (<code>CustomResourceController</code>) looks like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=kt>int</span> <span class=n>workerCount</span><span class=o>,</span> <span class=n>String</span> <span class=n>kind</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>...</span> <span class=n>childListeners</span><span class=o>)</span> <span class=o>{</span>

    <span class=c1>// Create the informer
</span><span class=c1></span>    <span class=n>SharedIndexInformer</span><span class=o>&lt;</span><span class=n>O</span><span class=o>&gt;</span> <span class=n>informer</span> <span class=o>=</span>
            <span class=n>connection</span><span class=o>.</span><span class=na>getSharedInformerFactory</span><span class=o>().</span><span class=na>sharedIndexInformerFor</span><span class=o>((</span><span class=n>CallGeneratorParams</span> <span class=n>params</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>connection</span><span class=o>.</span><span class=na>getCustomObjectsApi</span><span class=o>().</span><span class=na>listClusterCustomObjectCall</span><span class=o>(</span><span class=n>group</span><span class=o>,</span>
                            <span class=n>version</span><span class=o>,</span>
                            <span class=n>plural</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=n>params</span><span class=o>.</span><span class=na>resourceVersion</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>,</span>
                            <span class=n>params</span><span class=o>.</span><span class=na>timeoutSeconds</span><span class=o>,</span>
                            <span class=n>params</span><span class=o>.</span><span class=na>watch</span><span class=o>,</span>
                            <span class=kc>null</span><span class=o>),</span>
                    <span class=n>objectClass</span><span class=o>,</span>
                    <span class=n>listClass</span><span class=o>);</span>
    <span class=n>indexer</span> <span class=o>=</span> <span class=n>informer</span><span class=o>.</span><span class=na>getIndexer</span><span class=o>();</span>

    <span class=c1>// setup the informer to add requests to work-queue when events are received
</span><span class=c1></span>    <span class=n>RateLimitingQueue</span><span class=o>&lt;</span><span class=n>Request</span><span class=o>&gt;</span> <span class=n>workQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultRateLimitingQueue</span><span class=o>&lt;&gt;();</span>
    <span class=n>informer</span><span class=o>.</span><span class=na>addEventHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>CustomResourceEventHandler</span><span class=o>&lt;&gt;(</span><span class=n>workQueue</span><span class=o>));</span>

    <span class=c1>// initialize child listeners to inform work-queue on child-resource events
</span><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>ChildResourceListener</span> <span class=n>childListener</span> <span class=o>:</span> <span class=n>childListeners</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>childListener</span><span class=o>.</span><span class=na>initInformer</span><span class=o>(</span><span class=n>connection</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>,</span> <span class=n>group</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span> <span class=o>+</span> <span class=n>version</span><span class=o>,</span> <span class=n>kind</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=c1>// creating the internal controller
</span><span class=c1></span>    <span class=n>controller</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LeaderElectingController</span><span class=o>(</span><span class=n>getLeaderElector</span><span class=o>(),</span>
            <span class=n>ControllerBuilder</span><span class=o>.</span><span class=na>defaultBuilder</span><span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>getSharedInformerFactory</span><span class=o>())</span>
                    <span class=o>.</span><span class=na>withReconciler</span><span class=o>(</span><span class=k>new</span> <span class=n>CustomResourceReconciler</span><span class=o>(</span><span class=n>connection</span><span class=o>,</span>
                            <span class=n>objectMapper</span><span class=o>,</span>
                            <span class=n>group</span><span class=o>,</span>
                            <span class=n>plural</span><span class=o>,</span>
                            <span class=n>version</span><span class=o>,</span>
                            <span class=k>this</span><span class=o>))</span>
                    <span class=o>.</span><span class=na>withWorkQueue</span><span class=o>(</span><span class=n>workQueue</span><span class=o>)</span>
                    <span class=o>.</span><span class=na>withWorkerCount</span><span class=o>(</span><span class=n>workerCount</span><span class=o>)</span>
                    <span class=o>.</span><span class=na>withReadyFunc</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>informer</span><span class=o>.</span><span class=na>hasSynced</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>stream</span><span class=o>(</span><span class=n>childListeners</span><span class=o>)</span>
                            <span class=o>.</span><span class=na>allMatch</span><span class=o>(</span><span class=n>listener</span> <span class=o>-&gt;</span> <span class=n>listener</span><span class=o>.</span><span class=na>hasSynced</span><span class=o>()))</span>
                    <span class=o>.</span><span class=na>build</span><span class=o>());</span>

<span class=o>}</span>

<span class=kd>private</span> <span class=n>LeaderElector</span> <span class=nf>getLeaderElector</span><span class=o>()</span> <span class=o>{</span>

    <span class=c1>// setup leader-election so only one controller instance handles reconciliation
</span><span class=c1></span>    <span class=n>LeaseLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LeaseLock</span><span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>getSpace</span><span class=o>(),</span>
            <span class=n>objectClass</span><span class=o>.</span><span class=na>getSimpleName</span><span class=o>().</span><span class=na>toLowerCase</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;-controller-leader&#34;</span><span class=o>,</span>
            <span class=n>connection</span><span class=o>.</span><span class=na>getInstanceIdentity</span><span class=o>(),</span>
            <span class=n>connection</span><span class=o>.</span><span class=na>getApiClient</span><span class=o>());</span>

    <span class=c1>// See &#39;LeaderElectionConfig&#39; section at https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/leaderelection.go
</span><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>LeaderElector</span><span class=o>(</span><span class=k>new</span> <span class=n>LeaderElectionConfig</span><span class=o>(</span><span class=n>lock</span><span class=o>,</span>
            <span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>30</span><span class=o>),</span>
            <span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>15</span><span class=o>),</span>
            <span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>5</span><span class=o>)));</span>
<span class=o>}</span>
</code></pre></div><p>Our controller reconciles the state of <code>Mysql</code> resources when it receives API events from the Kubernetes API server. It creates <em>StatefulSet</em>, <em>Service</em>, and <em>Secret</em> child resources in response to <code>Mysql</code> resource being created. It also makes sure that those child resources stay available. To do that, it needs to listen for events for those child resources. Looking at the code above we can visualize how multiple <em>Informers</em> feed events into a single <em>WorkQueue</em>:</p>
<div class=box>
<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject>
<div class=img>
<img itemprop=thumbnail src=/img/k8s-controller-java/events.jpg alt="Populating the WorkQueue">
</div>
<a href=/img/k8s-controller-java/events.jpg itemprop=contentUrl></a>
</figure>
</div>
<h2 id=the-generic-reconciler-logic>The Generic Reconciler logic</h2>
<p>For every <em>Request</em> in the <em>WorkQueue</em>, our controller&rsquo;s reconcile logic compares the state of <code>Mysql</code> resource with the reality. For example, if it finds that a <em>StatefulSet</em> doesn&rsquo;t exist in the cluster, it needs to create it. Also, it needs to indicate that state in the <em>Status</em> section of our <em>Mysql</em> resource. The reconciler logic can be visualized like so:</p>
<div class=box>
<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject>
<div class=img>
<img itemprop=thumbnail src=/img/k8s-controller-java/reconcile.jpg alt="Reconciler Logic">
</div>
<a href=/img/k8s-controller-java/reconcile.jpg itemprop=contentUrl></a>
</figure>
</div>
<p>The reconciler logic at a high level is not very different from what reconcilers for other resource types might need to implement. So we created a generic <code>CustomResourceReconciler</code> which implements the logic in a generic fashion. It looks like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>import</span> <span class=nn>com.fnjoin.k8s.controller.config.KubernetesConnection</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>com.fasterxml.jackson.databind.ObjectMapper</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.common.KubernetesListObject</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.extended.controller.reconciler.Reconciler</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.extended.controller.reconciler.Request</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.extended.controller.reconciler.Result</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.RequiredArgsConstructor</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.SneakyThrows</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.Optional</span><span class=o>;</span>

<span class=nd>@RequiredArgsConstructor</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>CustomResourceReconciler</span><span class=o>&lt;</span><span class=n>O</span> <span class=kd>extends</span> <span class=n>CustomResource</span><span class=o>&lt;</span><span class=n>O</span><span class=o>&gt;,</span> <span class=n>L</span> <span class=kd>extends</span> <span class=n>KubernetesListObject</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Reconciler</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>CustomResourceController</span><span class=o>&lt;</span><span class=n>O</span><span class=o>,</span> <span class=n>L</span><span class=o>&gt;</span> <span class=n>controller</span><span class=o>;</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Result</span> <span class=nf>reconcile</span><span class=o>(</span><span class=n>Request</span> <span class=n>request</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>Optional</span><span class=o>&lt;</span><span class=n>O</span><span class=o>&gt;</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>getNamespace</span><span class=o>(),</span> <span class=n>request</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>obj</span><span class=o>.</span><span class=na>isPresent</span><span class=o>())</span> <span class=o>{</span>
                
                <span class=n>O</span> <span class=n>original</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
                <span class=n>String</span> <span class=n>uid</span> <span class=o>=</span> <span class=n>original</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getUid</span><span class=o>();</span>

                <span class=kt>boolean</span> <span class=n>resourceInDesiredState</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=na>isResourceInDesiredState</span><span class=o>(</span><span class=n>uid</span><span class=o>,</span> <span class=n>original</span><span class=o>);</span>
                <span class=kt>boolean</span> <span class=n>statusChangeNeeded</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>

                <span class=k>if</span> <span class=o>(</span><span class=n>resourceInDesiredState</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>statusChangeNeeded</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=na>isStatusChangeNeeded</span><span class=o>(</span><span class=n>uid</span><span class=o>,</span> <span class=n>original</span><span class=o>);</span>
                <span class=o>}</span>

                <span class=k>if</span> <span class=o>(!</span><span class=n>resourceInDesiredState</span> <span class=o>||</span> <span class=n>statusChangeNeeded</span><span class=o>)</span> <span class=o>{</span>
                    
                    <span class=c1>// apply the changes here
</span><span class=c1></span>                    <span class=n>O</span> <span class=n>changed</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=na>applyChanges</span><span class=o>(</span><span class=n>uid</span><span class=o>,</span> <span class=n>original</span><span class=o>.</span><span class=na>deepCopy</span><span class=o>());</span>
                    <span class=n>controller</span><span class=o>.</span><span class=na>applyStatusChanges</span><span class=o>(</span><span class=n>changed</span><span class=o>);</span>

                    <span class=n>String</span> <span class=n>resourceVersion</span> <span class=o>=</span> <span class=n>original</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getResourceVersion</span><span class=o>();</span>
                    <span class=n>replaceExisting</span><span class=o>(</span><span class=n>resourceVersion</span><span class=o>,</span> <span class=n>changed</span><span class=o>);</span>
                    <span class=k>return</span> <span class=k>new</span> <span class=n>Result</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>Result</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>Result</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@SneakyThrows</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>replaceExisting</span><span class=o>(</span><span class=n>String</span> <span class=n>resourceVersion</span><span class=o>,</span> <span class=n>O</span> <span class=n>applied</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>applied</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>setResourceVersion</span><span class=o>(</span><span class=n>resourceVersion</span><span class=o>);</span>
        <span class=n>connection</span><span class=o>.</span><span class=na>getCustomObjectsApi</span><span class=o>().</span><span class=na>replaceNamespacedCustomObject</span><span class=o>(</span><span class=n>group</span><span class=o>,</span>
                <span class=n>version</span><span class=o>,</span>
                <span class=n>applied</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getNamespace</span><span class=o>(),</span>
                <span class=n>plural</span><span class=o>,</span>
                <span class=n>applied</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
                <span class=n>applied</span><span class=o>,</span>
                <span class=kc>null</span><span class=o>,</span>
                <span class=kc>null</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>In the above code, all error handling and logging logic was removed to not distract from the core concepts - they are still present in the actual working code.</p>
<h2 id=mysql-custom-resource-in-java><code>Mysql</code> custom-resource in Java</h2>
<p>With the base package present, we need to implement the <code>CustomResource</code> interface to represent our custom-resource. Here is what that looks like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=kn>import</span> <span class=nn>io.kubernetes.client.common.KubernetesObject</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>CustomResource</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>KubernetesObject</span> <span class=o>{</span>
    <span class=n>T</span> <span class=nf>deepCopy</span><span class=o>();</span>
<span class=o>}</span>
</code></pre></div><p>With the implementation being <code>MysqlCustomResource</code> class and it looks like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=kn>import</span> <span class=nn>com.fnjoin.k8s.controller.customresource.base.CustomResource</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.common.KubernetesListObject</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.openapi.models.V1Condition</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.openapi.models.V1ListMeta</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.openapi.models.V1ObjectMeta</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.openapi.models.V1ObjectMetaBuilder</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.AllArgsConstructor</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.Builder</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.Data</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.NoArgsConstructor</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.Collections</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.HashMap</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.Map</span><span class=o>;</span>

<span class=nd>@Data</span>
<span class=nd>@Builder</span>
<span class=nd>@NoArgsConstructor</span>
<span class=nd>@AllArgsConstructor</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MysqlCustomResource</span> <span class=kd>implements</span> <span class=n>CustomResource</span><span class=o>&lt;</span><span class=n>MysqlCustomResource</span><span class=o>&gt;</span> <span class=o>{</span>

    <span class=n>String</span> <span class=n>apiVersion</span><span class=o>;</span>
    <span class=n>String</span> <span class=n>kind</span><span class=o>;</span>
    <span class=n>V1ObjectMeta</span> <span class=n>metadata</span><span class=o>;</span>
    <span class=n>Spec</span> <span class=n>spec</span><span class=o>;</span>
    <span class=n>Status</span> <span class=n>status</span><span class=o>;</span>

    <span class=nd>@Data</span>
    <span class=nd>@Builder</span>
    <span class=nd>@NoArgsConstructor</span>
    <span class=nd>@AllArgsConstructor</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Spec</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>storage</span><span class=o>;</span>
        <span class=n>String</span> <span class=n>memory</span><span class=o>;</span>
        <span class=n>String</span> <span class=n>cpu</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Data</span>
    <span class=nd>@Builder</span>
    <span class=nd>@NoArgsConstructor</span>
    <span class=nd>@AllArgsConstructor</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Status</span> <span class=o>{</span>
        <span class=kt>boolean</span> <span class=n>ready</span><span class=o>;</span>
        <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>List</span><span class=o>&lt;</span><span class=n>V1Condition</span><span class=o>&gt;</span> <span class=n>conditions</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Data</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>List</span> <span class=kd>implements</span> <span class=n>KubernetesListObject</span> <span class=o>{</span>
        <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>List</span><span class=o>&lt;</span><span class=n>MysqlCustomResource</span><span class=o>&gt;</span> <span class=n>items</span><span class=o>;</span>
        <span class=n>String</span> <span class=n>apiVersion</span><span class=o>;</span>
        <span class=n>String</span> <span class=n>kind</span><span class=o>;</span>
        <span class=n>V1ListMeta</span> <span class=n>metadata</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>MysqlCustomResource</span> <span class=nf>deepCopy</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>MysqlCustomResource</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
                <span class=o>.</span><span class=na>apiVersion</span><span class=o>(</span><span class=n>apiVersion</span><span class=o>)</span>
                <span class=o>.</span><span class=na>kind</span><span class=o>(</span><span class=n>kind</span><span class=o>)</span>
                <span class=o>.</span><span class=na>metadata</span><span class=o>(</span><span class=k>new</span> <span class=n>V1ObjectMetaBuilder</span><span class=o>()</span>
                        <span class=o>.</span><span class=na>withName</span><span class=o>(</span><span class=n>metadata</span><span class=o>.</span><span class=na>getName</span><span class=o>())</span>
                        <span class=o>.</span><span class=na>withNamespace</span><span class=o>(</span><span class=n>metadata</span><span class=o>.</span><span class=na>getNamespace</span><span class=o>())</span>
                        <span class=o>.</span><span class=na>withAnnotations</span><span class=o>(</span><span class=n>copyMap</span><span class=o>(</span><span class=n>metadata</span><span class=o>.</span><span class=na>getAnnotations</span><span class=o>()))</span>
                        <span class=o>.</span><span class=na>withLabels</span><span class=o>(</span><span class=n>copyMap</span><span class=o>(</span><span class=n>metadata</span><span class=o>.</span><span class=na>getLabels</span><span class=o>()))</span>
                        <span class=o>.</span><span class=na>withResourceVersion</span><span class=o>(</span><span class=n>metadata</span><span class=o>.</span><span class=na>getResourceVersion</span><span class=o>())</span>
                        <span class=o>.</span><span class=na>build</span><span class=o>())</span>
                <span class=o>.</span><span class=na>spec</span><span class=o>(</span><span class=n>Spec</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
                        <span class=o>.</span><span class=na>storage</span><span class=o>(</span><span class=n>spec</span><span class=o>.</span><span class=na>getStorage</span><span class=o>())</span>
                        <span class=o>.</span><span class=na>memory</span><span class=o>(</span><span class=n>spec</span><span class=o>.</span><span class=na>getMemory</span><span class=o>())</span>
                        <span class=o>.</span><span class=na>cpu</span><span class=o>(</span><span class=n>spec</span><span class=o>.</span><span class=na>getCpu</span><span class=o>())</span>
                        <span class=o>.</span><span class=na>build</span><span class=o>())</span>
                <span class=o>.</span><span class=na>status</span><span class=o>(</span><span class=n>status</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span>
                        <span class=n>Status</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
                                <span class=o>.</span><span class=na>ready</span><span class=o>(</span><span class=n>status</span><span class=o>.</span><span class=na>isReady</span><span class=o>())</span>
                                <span class=o>.</span><span class=na>conditions</span><span class=o>(</span><span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>status</span><span class=o>.</span><span class=na>getConditions</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>()</span> <span class=o>:</span> <span class=n>status</span><span class=o>.</span><span class=na>getConditions</span><span class=o>()))</span>
                                <span class=o>.</span><span class=na>build</span><span class=o>()</span> <span class=o>:</span>
                        <span class=n>Status</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
                                <span class=o>.</span><span class=na>ready</span><span class=o>(</span><span class=kc>false</span><span class=o>)</span>
                                <span class=o>.</span><span class=na>conditions</span><span class=o>(</span><span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;())</span>
                                <span class=o>.</span><span class=na>build</span><span class=o>())</span>
                <span class=o>.</span><span class=na>build</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>copyMap</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=n>map</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;(</span><span class=n>map</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyMap</span><span class=o>()</span> <span class=o>:</span> <span class=n>map</span><span class=o>);</span>
    <span class=o>}</span>

</code></pre></div><p>Lombok saves us from lots of boiler-plate java-bean code. The main thing to notice is the <code>deepCopy()</code> method, which is very useful during reconciliation. A future experiment would be to implement this as Java <code>record</code> type. Its not clear how well that would work yet because of how Kubernetes Client for Java internally uses <em>Gson</em> for converting JSON representation of these resources to Java.</p>
<h2 id=mysql-controllerreconcile-logic><code>Mysql</code> controller/reconcile logic</h2>
<p>The generic reconciler logic mentioned earlier relied on extenders of our <code>CustomResourceController</code> abstract class to implement various methods. Here is what our implementation looks like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>import</span> <span class=nn>com.fnjoin.k8s.controller.config.KubernetesConnection</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>com.fnjoin.k8s.controller.customresource.base.ChildResourceListener</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>com.fnjoin.k8s.controller.customresource.base.CustomResourceController</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>com.fasterxml.jackson.databind.ObjectMapper</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.openapi.models.V1Condition</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>io.kubernetes.client.openapi.models.V1OwnerReference</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>lombok.extern.slf4j.Slf4j</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.stereotype.Service</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>javax.annotation.PostConstruct</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.List</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.Objects</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicBoolean</span><span class=o>;</span>

<span class=nd>@Service</span>
<span class=nd>@Slf4j</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MysqlCustomResourceController</span> <span class=kd>extends</span> <span class=n>CustomResourceController</span><span class=o>&lt;</span><span class=n>MysqlCustomResource</span><span class=o>,</span> <span class=n>MysqlCustomResource</span><span class=o>.</span><span class=na>List</span><span class=o>&gt;</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>StatefulsetListener</span> <span class=n>statefulsetListener</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>SecretListener</span> <span class=n>secretListener</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ServiceListener</span> <span class=n>serviceListener</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>MysqlCustomResourceController</span><span class=o>(</span><span class=n>KubernetesConnection</span> <span class=n>connection</span><span class=o>,</span> <span class=n>ObjectMapper</span> <span class=n>objectMapper</span><span class=o>,</span> <span class=n>StatefulsetListener</span> <span class=n>statefulsetListener</span><span class=o>,</span> <span class=n>SecretListener</span> <span class=n>secretListener</span><span class=o>,</span> <span class=n>ServiceListener</span> <span class=n>serviceListener</span><span class=o>)</span> <span class=o>{</span>
        <span class=kd>super</span><span class=o>(</span><span class=n>connection</span><span class=o>,</span>
                <span class=n>objectMapper</span><span class=o>,</span>
                <span class=s>&#34;fnjoin.com&#34;</span><span class=o>,</span>
                <span class=s>&#34;mysqls&#34;</span><span class=o>,</span>
                <span class=s>&#34;v1&#34;</span><span class=o>,</span>
                <span class=n>MysqlCustomResource</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
                <span class=n>MysqlCustomResource</span><span class=o>.</span><span class=na>List</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
        <span class=k>this</span><span class=o>.</span><span class=na>statefulsetListener</span> <span class=o>=</span> <span class=n>statefulsetListener</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>secretListener</span> <span class=o>=</span> <span class=n>secretListener</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>serviceListener</span> <span class=o>=</span> <span class=n>serviceListener</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@PostConstruct</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>()</span> <span class=o>{</span>
        <span class=kd>super</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>2</span><span class=o>,</span> <span class=s>&#34;Mysql&#34;</span><span class=o>,</span> <span class=n>statefulsetListener</span><span class=o>,</span> <span class=n>secretListener</span><span class=o>,</span> <span class=n>serviceListener</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isResourceInDesiredState</span><span class=o>(</span><span class=n>String</span> <span class=n>uid</span><span class=o>,</span> <span class=n>MysqlCustomResource</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>

        <span class=n>String</span> <span class=n>namespace</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getNamespace</span><span class=o>();</span>
        <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getName</span><span class=o>();</span>

        <span class=k>return</span> <span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>statefulsetListener</span><span class=o>,</span> <span class=n>secretListener</span><span class=o>,</span> <span class=n>serviceListener</span><span class=o>)</span>
                <span class=o>.</span><span class=na>stream</span><span class=o>()</span>
                <span class=o>.</span><span class=na>allMatch</span><span class=o>(</span><span class=n>listener</span> <span class=o>-&gt;</span> <span class=n>listener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>).</span><span class=na>isPresent</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isStatusChangeNeeded</span><span class=o>(</span><span class=n>String</span> <span class=n>uid</span><span class=o>,</span> <span class=n>MysqlCustomResource</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>applyStatusChanges</span><span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>deepCopy</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>MysqlCustomResource</span> <span class=nf>applyChanges</span><span class=o>(</span><span class=n>String</span> <span class=n>uid</span><span class=o>,</span> <span class=n>MysqlCustomResource</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>

        <span class=n>String</span> <span class=n>namespace</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getNamespace</span><span class=o>();</span>
        <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getName</span><span class=o>();</span>
        <span class=n>V1OwnerReference</span> <span class=n>reference</span> <span class=o>=</span> <span class=n>createOwnerReference</span><span class=o>(</span><span class=n>uid</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>

        <span class=k>if</span> <span class=o>(</span><span class=n>statefulsetListener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>).</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>createStatefulSet</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>,</span> <span class=n>reference</span><span class=o>,</span> <span class=n>resource</span><span class=o>.</span><span class=na>getSpec</span><span class=o>());</span>
        <span class=o>}</span>

        <span class=k>if</span> <span class=o>(</span><span class=n>secretListener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>).</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>secretListener</span><span class=o>.</span><span class=na>createSecret</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>,</span> <span class=n>reference</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=k>if</span> <span class=o>(</span><span class=n>serviceListener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>).</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>serviceListener</span><span class=o>.</span><span class=na>createService</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>,</span> <span class=n>reference</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=k>return</span> <span class=n>resource</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>applyStatusChanges</span><span class=o>(</span><span class=n>MysqlCustomResource</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>

        <span class=n>String</span> <span class=n>namespace</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getNamespace</span><span class=o>();</span>
        <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>().</span><span class=na>getName</span><span class=o>();</span>

        <span class=n>AtomicBoolean</span> <span class=n>changed</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicBoolean</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
        <span class=n>AtomicBoolean</span> <span class=n>isReady</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicBoolean</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>V1Condition</span><span class=o>&gt;</span> <span class=n>conditions</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>getStatus</span><span class=o>().</span><span class=na>getConditions</span><span class=o>();</span>

        <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>)</span>
                <span class=o>.</span><span class=na>ifPresentOrElse</span><span class=o>(</span><span class=n>sts</span> <span class=o>-&gt;</span> <span class=o>{</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>sts</span><span class=o>.</span><span class=na>getStatus</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span>
                            <span class=n>Objects</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>sts</span><span class=o>.</span><span class=na>getStatus</span><span class=o>().</span><span class=na>getReadyReplicas</span><span class=o>(),</span> <span class=n>Integer</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1</span><span class=o>))</span> <span class=o>&amp;&amp;</span>
                            <span class=n>Objects</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>sts</span><span class=o>.</span><span class=na>getStatus</span><span class=o>().</span><span class=na>getReplicas</span><span class=o>(),</span> <span class=n>Integer</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span> <span class=o>{</span>
                        <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>AVAILABLE</span><span class=o>,</span> <span class=s>&#34;StatefulSet&#34;</span><span class=o>);</span>
                    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                        <span class=n>isReady</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
                        <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>CREATING</span><span class=o>,</span> <span class=s>&#34;StatefulSet&#34;</span><span class=o>);</span>
                    <span class=o>}</span>
                <span class=o>},</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
                    <span class=n>isReady</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
                    <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>MISSING</span><span class=o>,</span> <span class=s>&#34;StatefulSet&#34;</span><span class=o>);</span>
                <span class=o>});</span>

        <span class=n>serviceListener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>)</span>
                <span class=o>.</span><span class=na>ifPresentOrElse</span><span class=o>(</span><span class=n>service</span> <span class=o>-&gt;</span> <span class=o>{</span>
                    <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>AVAILABLE</span><span class=o>,</span> <span class=s>&#34;Service&#34;</span><span class=o>);</span>
                <span class=o>},</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
                    <span class=n>isReady</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
                    <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>MISSING</span><span class=o>,</span> <span class=s>&#34;Service&#34;</span><span class=o>);</span>
                <span class=o>});</span>

        <span class=n>secretListener</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>name</span><span class=o>)</span>
                <span class=o>.</span><span class=na>ifPresentOrElse</span><span class=o>(</span><span class=n>secret</span> <span class=o>-&gt;</span> <span class=o>{</span>
                    <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>AVAILABLE</span><span class=o>,</span> <span class=s>&#34;Secret&#34;</span><span class=o>);</span>
                <span class=o>},</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
                    <span class=n>isReady</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
                    <span class=n>statefulsetListener</span><span class=o>.</span><span class=na>updateCondition</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>conditions</span><span class=o>,</span> <span class=n>ChildResourceListener</span><span class=o>.</span><span class=na>ConditionStatus</span><span class=o>.</span><span class=na>MISSING</span><span class=o>,</span> <span class=s>&#34;Secret&#34;</span><span class=o>);</span>
                <span class=o>});</span>

        <span class=c1>// change the ready flag if needed
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>getStatus</span><span class=o>().</span><span class=na>isReady</span><span class=o>()</span> <span class=o>!=</span> <span class=n>isReady</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>resource</span><span class=o>.</span><span class=na>getStatus</span><span class=o>().</span><span class=na>setReady</span><span class=o>(</span><span class=n>isReady</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
            <span class=n>changed</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=k>return</span> <span class=n>changed</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>Notice that <code>Mysql</code> custom-resource specific logic is not that complex.</p>
<h2 id=desired-result>Desired result</h2>
<p>At this point we can run the controller - outside of the cluster, in a terminal or in the IDE. It is spring-boot app so <code>./gradlew clean bootrun</code> should do the trick. After the <em>CRD</em> has been applied and the controller is running. We can apply the <a href=https://github.com/fnjoin/mysql-k8s-controller/blob/main/k8s/sample1.yaml>sample <em>Mysql</em> YAML</a> to the cluster using <code>kubectl</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f k8s/sample1.yaml
</code></pre></div><p>The resuls of <code>kubectl get mysql db-1 -o yaml</code> should then look like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>fnjoin.com/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Mysql</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-11-01T21:41:32Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>generation</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-1</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;97078&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>52a2abef-bfe8-433c-a2bf-37a40c6f70e4</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span><span class=w>  </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-11-01T17:41:31.957460-04:00&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=l>AVAILABLE</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w>    </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-11-01T17:41:31.957475-04:00&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=l>AVAILABLE</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w>    </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-11-01T17:41:38.431363-04:00&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=l>CREATING</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span><span class=w>  </span><span class=nt>ready</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></code></pre></div><p>Notice the <code>status</code> section with the <code>ready</code> flag and the various <code>condition</code> objects. They were updated by the controller as our custom-resource was reconciled.</p>
<h2 id=running-the-controller-in-the-cluster>Running the controller in the cluster</h2>
<p>We will assume that our controller will run in its own <em>Namespace</em> called <code>mysql-controller</code> and that namespace exists. The following RBAC related <em>ClusterRole</em> and <em>ClusterRoleBinding</em> will need to be applied first to setup appropriate level of permissions for our controller:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-controller</span><span class=w>
</span><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;secrets&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;services&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;create&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;statefulsets&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;create&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;coordination.k8s.io&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;leases&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;fnjoin.com&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;mysqls&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-controller</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>mysql-controller</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-controller</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></code></pre></div><p>Notice the permissions are limited to what the controller code actually needs. They could be tightened up a bit more but we will leave that to another post. The rest of the setup would include applying a <em>Deployment</em> to the namespace after the code has been bundled as an OCI image. The <em>Deployment</em> can look like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-controller</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>mysql-controller</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>java</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>java</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>fnjoin.com/mysql-controller-java:1.0</span><span class=w>
</span><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPACE</span><span class=w>
</span><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.namespace</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>INSTANCEIDENTITY</span><span class=w>
</span><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span></code></pre></div><p>Notice the environment variables <code>SPACE</code> and <code>INSTANCEIDENTITY</code>. They are used for leader-election purposes - see the <a href=https://github.com/fnjoin/mysql-k8s-controller/blob/main/src/main/resources/application.yml><code>application.yaml</code></a> and <a href=https://github.com/fnjoin/mysql-k8s-controller/blob/main/src/main/java/com/fnjoin/k8s/controller/config/KubernetesConnection.java><code>KubernetesConnection.java</code></a> in the code-base to see how they are used.</p>
<p>The deployment YAML also assumes that the controller code will be bundled into an OCI image called <code>fnjoin.com/mysql-controller-java:1.0</code>. How you do that was explained in <a href=../2021-11-28-creating-images>Kubernetes with Java - Creating Images</a>. TL;DR - there is a <a href=https://github.com/fnjoin/mysql-k8s-controller/blob/main/k8s/create-java-image.sh>convinience script</a> in the code-base that will do that.</p>
<h2 id=conclusion>Conclusion</h2>
<p>It is possible to write Kubernetes controllers in Java, we just need to understand the support classes provided by the Kubernetes Client for Java library. There is a lack of good information on how to write controllers in Java - hopefully this post will help solve that issue. Our choice to use spring-boot was also intentional since a lot of Java developers are already familiar with it. In addition to providing its core capability of dependency injection, it also makes it easy to bundle the code into OCI images. Compiling to a <em>native-image</em> are almost GA with latest spring-boot release and will make Java/spring-boot based controllers start up even faster and use far less CPU and memory resources. That last reason has typically been a hallmark for binaries created with <em>Golang</em>. Also, we have a huge ecosystem of OSS software that can help us in creating these resources.</p>
<p>Reach out if you would like to learn more about any of the topics discussed here. Also, if you have written a Kubernetes controller in any language, what were some the gotchas you faced? We would love to hear from you.</p>
<h2 id=references>References</h2>
<ul>
<li>To see working code from this post (with slight modifications), see the <a href=https://github.com/fnjoin/mysql-k8s-controller>Git repository</a>.</li>
<li>If you want to know how to bundle a spring-boot app like this as an OCI image (also known as Docker image), see <a href=../2021-11-28-creating-images>Kubernetes with Java - Creating Images</a></li>
<li>If you want to know how to run an app like this inside a Kubernetes cluster, see <a href=../2021-09-11-running-in-cluster>Kubernetes with Java - Running in the Cluster</a></li>
</ul>
<div class=blog-tags>
<a href=https://fnjoin.com//tags/java/>java</a>&nbsp;
<a href=https://fnjoin.com//tags/kubernetes/>kubernetes</a>&nbsp;
<a href=https://fnjoin.com//tags/spring-boot/>spring-boot</a>&nbsp;
<a href=https://fnjoin.com//tags/api-events/>api-events</a>&nbsp;
<a href=https://fnjoin.com//tags/controller/>controller</a>&nbsp;
<a href=https://fnjoin.com//tags/mysql/>mysql</a>&nbsp;
</div>
<hr>
<section id=social-share>
<div class="list-inline footer-links">
<div class=share-box aria-hidden=true>
<ul class=share>
<li>
<a href="//twitter.com/share?url=https%3a%2f%2ffnjoin.com%2fpost%2f2022-11-08-k8s-controller-java%2f&text=Kubernetes%20Controller%20Pattern%20Example%20with%20Java%20and%20MySQL&via=fnjoin" target=_blank title="Share on Twitter">
<i class="fab fa-twitter"></i>
</a>
</li>
<li>
<a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ffnjoin.com%2fpost%2f2022-11-08-k8s-controller-java%2f" target=_blank title="Share on Facebook">
<i class="fab fa-facebook"></i>
</a>
</li>
<li>
<a href="//reddit.com/submit?url=https%3a%2f%2ffnjoin.com%2fpost%2f2022-11-08-k8s-controller-java%2f&title=Kubernetes%20Controller%20Pattern%20Example%20with%20Java%20and%20MySQL" target=_blank title="Share on Reddit">
<i class="fab fa-reddit"></i>
</a>
</li>
<li>
<a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2ffnjoin.com%2fpost%2f2022-11-08-k8s-controller-java%2f&title=Kubernetes%20Controller%20Pattern%20Example%20with%20Java%20and%20MySQL" target=_blank title="Share on LinkedIn">
<i class="fab fa-linkedin"></i>
</a>
</li>
<li>
<a href="//www.stumbleupon.com/submit?url=https%3a%2f%2ffnjoin.com%2fpost%2f2022-11-08-k8s-controller-java%2f&title=Kubernetes%20Controller%20Pattern%20Example%20with%20Java%20and%20MySQL" target=_blank title="Share on StumbleUpon">
<i class="fab fa-stumbleupon"></i>
</a>
</li>
<li>
<a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2ffnjoin.com%2fpost%2f2022-11-08-k8s-controller-java%2f&description=Kubernetes%20Controller%20Pattern%20Example%20with%20Java%20and%20MySQL" target=_blank title="Share on Pinterest">
<i class="fab fa-pinterest"></i>
</a>
</li>
</ul>
</div>
</div>
</section>
<h4 class=see-also>See also</h4>
<ul>
<li><a href=/post/2022-03-20-fast-java-startup/>10x Faster Spring Boot Startup Times</a></li>
<li><a href=/post/2022-02-07-fav-k8s-cli-tool/>k9s - My Favorite Kubernetes Tool</a></li>
<li><a href=/post/2022-01-03-k8s-event-handling/>Kubernetes with Java - Handling Events</a></li>
<li><a href=/post/2021-11-28-creating-images/>Kubernetes with Java - Creating Images</a></li>
<li><a href=/post/2021-09-11-running-in-cluster/>Kubernetes with Java - Running in the Cluster</a></li>
</ul>
</article>
<ul class="pager blog-pager">
<li class=previous>
<a href=https://fnjoin.com/post/2022-03-20-fast-java-startup/ data-toggle=tooltip data-placement=top title="10x Faster Spring Boot Startup Times">&larr; Previous Post</a>
</li>
</ul>
</div>
</div>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center footer-links">
<li>
<a href=mailto:contact@fnjoin.com title="Email us">
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://github.com/fnjoin title=GitHub>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://twitter.com/fnjoin title=Twitter>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href title=RSS>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
<p class="credits copyright text-muted">
<a href=https://fnjoin.com>Salman Malik, Archie Cowan</a>
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://fnjoin.com/>fn:join</a>
</p>
<p class="credits theme-by text-muted">
Views and opinions expressed by the authors are solely their own and are not the views of their employers.
</p>
</div>
</div>
</div>
</footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://fnjoin.com/js/main.js></script>
<script src=https://fnjoin.com/js/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://fnjoin.com/js/load-photoswipe.js></script>
</body>
</html>